name: "Global Request Validation"

on:
  pull_request:
    branches: [ main ]
    # Reagiert auf Erstellung, Bearbeitung der PR-Beschreibung und neue Commits
    types: [opened, edited, synchronize]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Validators
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          pip install html5lib

      - name: Check PR Description (Legal Agreement)
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Checking legal agreement checkboxes..."
          
          # Suche nach [x] oder [X] gefolgt vom Kerntext (ohne Satzzeichen-Zwang am Ende)
          CHECK1=$(echo "$PR_BODY" | grep -Ei "\[x\] I accept the Alex Gaming Proprietary" && echo "ok" || echo "miss")
          CHECK2=$(echo "$PR_BODY" | grep -Ei "\[x\] I confirm that I will not clone" && echo "ok" || echo "miss")
          CHECK3=$(echo "$PR_BODY" | grep -Ei "\[x\] I understand that maintainers only process" && echo "ok" || echo "miss")

          echo "Status: 1:$CHECK1, 2:$CHECK2, 3:$CHECK3"

          if [ "$CHECK1" = "ok" ] && [ "$CHECK2" = "ok" ] && [ "$CHECK3" = "ok" ]; then
            echo "✅ Legal agreement verified."
          else
            echo "❌ ERROR: You must check all 3 boxes in the 'Legal Agreement' section!"
            echo "Make sure to use [x] or [X] inside the brackets."
            exit 1
          fi
          
      - name: Validate Files and Structure
        run: |
          errors=0
          
          # 1. Syntax Prüfung für alle Dateien im Repo
          echo "Starting syntax validation..."
          for file in $(find . -type f -not -path '*/.*'); do
            if [[ $file == *.json ]]; then
              jq . "$file" > /dev/null || { echo "❌ Invalid JSON in $file"; errors=$((errors+1)); }
            elif [[ $file == *.html ]]; then
              python3 -m html.dom.minidom "$file" > /dev/null 2>&1 || { echo "⚠️ Potential HTML issue in $file"; }
            elif [[ $file == *.sh ]]; then
              bash -n "$file" || { echo "❌ Bash syntax error in $file"; errors=$((errors+1)); }
            fi
          done

          # 2. Strukturprüfung (Nur Änderungen in PR/ oder .github/ erlaubt)
          echo "Checking file paths..."
          # Vergleicht den aktuellen Branch mit dem Ziel-Branch (main)
          changed_files=$(git diff --name-only origin/main...HEAD)
          for f in $changed_files; do
            # Ausnahmen für Systemdateien und den PR-Ordner
            if [[ ! $f == PR/* ]] && [[ ! $f == .github/* ]] && [[ ! $f == "validate.sh" ]] && [[ ! $f == "README.md" ]]; then
              echo "❌ ERROR: Modification of '$f' is prohibited. Please only submit files inside the 'PR/' folder."
              errors=$((errors+1))
            fi
          done

          if [ $errors -gt 0 ]; then
            echo "Validation failed with $errors errors total."
            exit 1
          fi
          echo "✅ All checks passed successfully."
